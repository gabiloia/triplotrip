import{d as S,q as p,x as U,y as M,c as N,o as g,a as u,e as i,w as o,b as c,u as r,B as h,F as q,r as V,t as k,N as j,n as O,z as L,g as G,l as J,s as R,A as W,f as H}from"./B3WipU5-.js";import{u as K}from"./DgIvEEXs.js";import{N as Q,a as _}from"./BGqAsCHy.js";import{N as x}from"./B3QGDZVw.js";import{N as X,a as Y}from"./BBQI4reW.js";import{N as Z}from"./DBEIOBsV.js";import"./Bvs3lIJ3.js";import"./CWoEXOdx.js";import"./DAT_1hEH.js";import"./CHEHCL6Y.js";import"./DkwI_4jA.js";import"./CXdoimxu.js";import"./ChrZyf0g.js";import"./C2161hUv.js";import"./BetshPO0.js";const ee={class:"page"},te={class:"main"},ae={class:"mb-4 flex"},oe={class:"masonry"},re=["alt","src"],ie=S({__name:"Propiedades",setup(le){const m=p([]),d=p(!1),n=p(!1),s=p(null),l=p({Titulo:"",Descripcion:"",FotoPrincipal:null}),f=p(null),v=U(),F=K();function I(e){return!e||!e.url?"/images/default.jpg":e.url.startsWith("http")?e.url:`https://admin.triplotrip.com${e.url}`}function $(){n.value=!1,s.value=null,l.value={Titulo:"",Descripcion:"",FotoPrincipal:null},d.value=!0}async function T(){try{const e=localStorage.getItem("auth_token");if(!e)return;f.value=await $fetch("https://admin.triplotrip.com/api/users/me",{headers:{Authorization:`Bearer ${e}`}});const t=W.stringify({filters:{owner:{documentId:{$eq:f.value.documentId}}},populate:["FotoPrincipal"]},{encodeValuesOnly:!0}),a=await $fetch(`https://admin.triplotrip.com/api/propiedades?${t}`,{headers:{Authorization:`Bearer ${e}`}});m.value=a.data||[]}catch(e){console.error("Error cargando propiedades:",e)}}function C({file:e}){l.value.FotoPrincipal=e.file}function b(e){n.value=!0,s.value=e.documentId,l.value={Titulo:e.Titulo,Descripcion:e.Descripcion,FotoPrincipal:null},d.value=!0}function B(){F.warning({title:"¿Eliminar propiedad?",content:"Esta acción no se puede deshacer.",positiveText:"Eliminar",negativeText:"Cancelar",onPositiveClick:()=>z()})}async function z(){try{const e=localStorage.getItem("auth_token");if(!e||!s.value)return;const t=await fetch(`https://admin.triplotrip.com/api/propiedades/${s.value}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}});if(!t.ok){const a=await t.json().catch(()=>({}));throw new Error(a.message||`Error borrando propiedad: ${t.statusText}`)}m.value=m.value.filter(a=>a.documentId!==s.value),v.success({title:"Propiedad eliminada"}),d.value=!1,s.value=null,n.value=!1}catch(e){console.error(e),v.error({title:"Error",content:e.message||"No se pudo eliminar"})}}async function A(){try{const e=localStorage.getItem("auth_token");if(!e||!f.value)throw new Error("No autenticado");let t=null;if(l.value.FotoPrincipal){const E=new FormData;E.append("files",l.value.FotoPrincipal);const y=await fetch("https://admin.triplotrip.com/api/upload",{method:"POST",headers:{Authorization:`Bearer ${e}`},body:E});if(!y.ok)throw new Error(`Error subiendo imagen: ${y.statusText}`);const w=await y.json();t=Array.isArray(w)?w[0].id:w.id}const a={Titulo:l.value.Titulo,Descripcion:l.value.Descripcion};t&&(a.FotoPrincipal=t),n.value||(a.owner={connect:[f.value.id]});const P=n.value?`https://admin.triplotrip.com/api/propiedades/${s.value}`:"https://admin.triplotrip.com/api/propiedades",D=n.value?"PUT":"POST";await $fetch(P,{method:D,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({data:a})}),v.success({title:"Propiedad guardada correctamente"}),d.value=!1,l.value={Titulo:"",Descripcion:"",FotoPrincipal:null},s.value=null,n.value=!1,await T()}catch(e){console.error(e),v.error({title:"Error",content:e.message||"No se pudo guardar"})}}return M(T),(e,t)=>(g(),N("div",ee,[t[9]||(t[9]=u("div",{class:"page-header"},[u("div",{class:"title"},"Propiedades")],-1)),u("div",te,[u("div",ae,[i(r(h),{onClick:$},{default:o(()=>t[3]||(t[3]=[c("Nueva propiedad")])),_:1,__:[3]})]),u("div",oe,[(g(!0),N(q,null,V(m.value,(a,P)=>(g(),N("div",{key:a.documentId,class:"card-wrap"},[i(r(j),{hoverable:"",class:"property-card"},{cover:o(()=>[u("img",{class:"property-image",alt:a.Titulo||"Imagen",src:I(a.FotoPrincipal)},null,8,re)]),header:o(()=>[u("span",null,k(a.Titulo),1)]),default:o(()=>[u("p",null,k(a.Descripcion),1)]),footer:o(()=>[i(r(h),{size:"small",onClick:D=>b(a)},{default:o(()=>t[4]||(t[4]=[c("Editar")])),_:2,__:[4]},1032,["onClick"])]),_:2},1024)]))),128))]),i(r(R),{show:d.value,"onUpdate:show":t[2]||(t[2]=a=>d.value=a),preset:"dialog",title:n.value?"Editar propiedad":"Crear nueva propiedad"},{default:o(()=>[i(r(Q),{model:l.value,onSubmit:O(A,["prevent"])},{default:o(()=>[i(r(_),{label:"Título",required:""},{default:o(()=>[i(r(x),{value:l.value.Titulo,"onUpdate:value":t[0]||(t[0]=a=>l.value.Titulo=a),placeholder:"Título de la propiedad"},null,8,["value"])]),_:1}),i(r(_),{label:"Descripción",required:""},{default:o(()=>[i(r(x),{value:l.value.Descripcion,"onUpdate:value":t[1]||(t[1]=a=>l.value.Descripcion=a),type:"textarea",placeholder:"Descripción de la propiedad"},null,8,["value"])]),_:1}),i(r(_),{label:"Imagen principal"},{default:o(()=>[i(r(X),{max:1,"default-upload":!1,onChange:C},{default:o(()=>[i(r(Y),null,{default:o(()=>[i(r(L),{style:{"font-size":"16px"}},{default:o(()=>t[5]||(t[5]=[c("Click o arrastrá una imagen para subir")])),_:1,__:[5]}),i(r(Z),{depth:"3",style:{margin:"8px 0 0 0"}},{default:o(()=>t[6]||(t[6]=[c("Máximo 1 imagen.")])),_:1,__:[6]})]),_:1})]),_:1})]),_:1}),i(r(_),null,{default:o(()=>[n.value?(g(),G(r(h),{key:0,onClick:B},{default:o(()=>t[7]||(t[7]=[c("Eliminar")])),_:1,__:[7]})):J("",!0),i(r(h),{type:"primary","attr-type":"submit"},{default:o(()=>t[8]||(t[8]=[c("Guardar")])),_:1,__:[8]})]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])])]))}}),Te=H(ie,[["__scopeId","data-v-71a86f97"]]);export{Te as default};
