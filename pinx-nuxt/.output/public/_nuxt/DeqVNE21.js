import{d as b,q as s,x as A,y as S,c as d,o as c,a as r,e as p,w as n,b as D,u as m,B as $,F as M,r as z,t as x,N as q,n as L,s as O,A as U,f as V}from"./CxJvYK31.js";import{u as j}from"./IRfJZSG6.js";import{N as J}from"./C73JGb5y.js";const R={class:"page"},W={key:0,class:"text-center my-4"},G={key:1,class:"text-center my-4 text-green-600"},H={class:"main"},K={class:"mb-4 flex"},Q={class:"masonry"},X=["alt","src"],Y=b({__name:"Propiedades",setup(Z){const g=s([]),l=s(!1),i=s(!1),f=s(null),o=s({Titulo:"",Descripcion:"",FotoPrincipal:null}),v=s(null),w=A();j();const u=s(!0);let h=0;function I(e){return!e||!e.url?"/images/default.jpg":e.url.startsWith("http")?e.url:`https://admin.triplotrip.com${e.url}`}function E(){i.value=!1,f.value=null,o.value={Titulo:"",Descripcion:"",FotoPrincipal:null},l.value=!0}async function P(){try{u.value=!0;const e=localStorage.getItem("auth_token");if(!e)return;v.value=await $fetch("https://admin.triplotrip.com/api/users/me",{headers:{Authorization:`Bearer ${e}`}});const t=U.stringify({filters:{owner:{documentId:{$eq:v.value.documentId}}},populate:["FotoPrincipal"]},{encodeValuesOnly:!0}),a=await $fetch(`https://admin.triplotrip.com/api/propiedades?${t}`,{headers:{Authorization:`Bearer ${e}`}});g.value=a.data||[],h=g.value.length,h===0&&(u.value=!1)}catch(e){console.error("Error cargando propiedades:",e),u.value=!1}}function T(){h--,h<=0&&(u.value=!1)}function C(e){i.value=!0,f.value=e.documentId,o.value={Titulo:e.Titulo,Descripcion:e.Descripcion,FotoPrincipal:null},l.value=!0}async function B(){try{const e=localStorage.getItem("auth_token");if(!e||!v.value)throw new Error("No autenticado");let t=null;if(o.value.FotoPrincipal){const k=new FormData;k.append("files",o.value.FotoPrincipal);const _=await fetch("https://admin.triplotrip.com/api/upload",{method:"POST",headers:{Authorization:`Bearer ${e}`},body:k});if(!_.ok)throw new Error(`Error subiendo imagen: ${_.statusText}`);const y=await _.json();t=Array.isArray(y)?y[0].id:y.id}const a={Titulo:o.value.Titulo,Descripcion:o.value.Descripcion};t&&(a.FotoPrincipal=t),i.value||(a.owner={connect:[v.value.id]});const F=i.value?`https://admin.triplotrip.com/api/propiedades/${f.value}`:"https://admin.triplotrip.com/api/propiedades",N=i.value?"PUT":"POST";await $fetch(F,{method:N,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({data:a})}),w.success({title:"Propiedad guardada correctamente"}),l.value=!1,o.value={Titulo:"",Descripcion:"",FotoPrincipal:null},f.value=null,i.value=!1,await P()}catch(e){console.error(e),w.error({title:"Error",content:e.message||"No se pudo guardar"})}}return S(P),(e,t)=>(c(),d("div",R,[u.value?(c(),d("div",W," Cargando imÃ¡genes... ")):(c(),d("div",G," Todo descargado ")),t[3]||(t[3]=r("div",{class:"page-header"},[r("div",{class:"title"},"Propiedades")],-1)),r("div",H,[r("div",K,[p(m($),{onClick:E},{default:n(()=>t[1]||(t[1]=[D("Nueva propiedad")])),_:1,__:[1]})]),r("div",Q,[(c(!0),d(M,null,z(g.value,(a,F)=>(c(),d("div",{key:a.documentId,class:"card-wrap"},[p(m(q),{hoverable:"",class:"property-card"},{cover:n(()=>[r("img",{class:"property-image",alt:a.Titulo||"Imagen",src:I(a.FotoPrincipal),onLoad:T,onError:T},null,40,X)]),header:n(()=>[r("span",null,x(a.Titulo),1)]),default:n(()=>[r("p",null,x(a.Descripcion),1)]),footer:n(()=>[p(m($),{size:"small",onClick:N=>C(a)},{default:n(()=>t[2]||(t[2]=[D("Editar")])),_:2,__:[2]},1032,["onClick"])]),_:2},1024)]))),128))]),p(m(O),{show:l.value,"onUpdate:show":t[0]||(t[0]=a=>l.value=a),preset:"dialog",title:i.value?"Editar propiedad":"Crear nueva propiedad"},{default:n(()=>[p(m(J),{model:o.value,onSubmit:L(B,["prevent"])},null,8,["model"])]),_:1},8,["show","title"])])]))}}),oe=V(Y,[["__scopeId","data-v-91e62957"]]);export{oe as default};
