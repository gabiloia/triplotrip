import{d as W,x as H,y as K,o as c,c as y,n as E,a as s,e as i,w as o,b as m,u as l,B as w,F as Q,r as X,t as b,N as Y,g as N,z as U,p as Z,s as u,A as ee,f as ae}from"./BboPWEKj.js";import{u as te}from"./BId3NNpn.js";import{N as oe,a as k}from"./BnadAGO8.js";import{N as L}from"./DawznoV1.js";import{N as S,a as le}from"./C9x3Mxu6.js";import"./YgjvrVMl.js";import"./CBN863Oo.js";import"./DqYVDO9Y.js";import"./DnIKkyzR.js";import"./CWhe2oSJ.js";import"./BXMLvpzM.js";import"./uD1lXFsz.js";import"./C2161hUv.js";import"./Cf99Tf4m.js";const re={class:"page"},ie={key:0,class:"text-center my-4"},ne={class:"main"},se={class:"mb-4 flex"},ue={class:"masonry"},de=["alt","src"],ce={style:{padding:"20px","text-align":"center"}},pe={key:0,class:"mt-2"},ve=["src"],me={class:"flex justify-end gap-2"},fe=W({__name:"Propiedades",setup(ge){const f=u([]),p=u(!1),n=u(!1),d=u(null),r=u({Titulo:"",Descripcion:"",FotoPrincipal:null}),_=u(null),F=H(),j=te(),D=u(),v=u(null),g=u(!1),h=u(!0);let P=0;const q={Titulo:{required:!0,message:"El título es obligatorio",trigger:["input","blur"]},Descripcion:{required:!0,message:"La descripción es obligatoria",trigger:["input","blur"]},FotoPrincipal:{validator:()=>r.value.FotoPrincipal||g.value?!0:new Error("La foto principal es obligatoria"),trigger:["change","blur"]}};function C(e){return!e||!e.url?"/images/default.jpg":e.url.startsWith("http")?e.url:`https://admin.triplotrip.com${e.url}`}function M(){n.value=!1,d.value=null,r.value={Titulo:"",Descripcion:"",FotoPrincipal:null},v.value=null,g.value=!1,p.value=!0}async function I(){try{h.value=!0;const e=localStorage.getItem("auth_token");if(!e)return;_.value=await $fetch("https://admin.triplotrip.com/api/users/me",{headers:{Authorization:`Bearer ${e}`}});const a=ee.stringify({filters:{owner:{documentId:{$eq:_.value.documentId}}},populate:["FotoPrincipal"]},{encodeValuesOnly:!0}),t=await $fetch(`https://admin.triplotrip.com/api/propiedades?${a}`,{headers:{Authorization:`Bearer ${e}`}});f.value=t.data||[],P=f.value.length,P===0&&(h.value=!1)}catch(e){console.error("Error cargando propiedades:",e),h.value=!1}}function $(){P--,P<=0&&(h.value=!1)}function V({file:e}){r.value.FotoPrincipal=e?.file??null}function O(e){n.value=!0,d.value=e.documentId,r.value={Titulo:e.Titulo??"",Descripcion:e.Descripcion??"",FotoPrincipal:null},v.value=e.FotoPrincipal??null,g.value=!!(v.value&&(v.value.url||v.value.id)),p.value=!0}function R(){j.warning({title:"¿Eliminar propiedad?",content:"Esta acción no se puede deshacer.",positiveText:"Eliminar",negativeText:"Cancelar",onPositiveClick:()=>G()})}async function G(){try{const e=localStorage.getItem("auth_token");if(!e||!d.value)return;const a=await fetch(`https://admin.triplotrip.com/api/propiedades/${d.value}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}});if(!a.ok){const t=await a.json().catch(()=>({}));throw new Error(t.message||`Error borrando propiedad: ${a.statusText}`)}f.value=f.value.filter(t=>t.documentId!==d.value),F.success({title:"Propiedad eliminada"}),p.value=!1,d.value=null,n.value=!1}catch(e){console.error(e),F.error({title:"Error",content:e.message||"No se pudo eliminar"})}}async function J(){try{await D.value?.validate();const e=localStorage.getItem("auth_token");if(!e||!_.value)throw new Error("No autenticado");let a=null;if(r.value.FotoPrincipal){const z=new FormData;z.append("files",r.value.FotoPrincipal);const T=await fetch("https://admin.triplotrip.com/api/upload",{method:"POST",headers:{Authorization:`Bearer ${e}`},body:z});if(!T.ok)throw new Error(`Error subiendo imagen: ${T.statusText}`);const x=await T.json();a=Array.isArray(x)?x[0].id:x.id}const t={Titulo:r.value.Titulo,Descripcion:r.value.Descripcion};a&&(t.FotoPrincipal=a),n.value||(t.owner={connect:[_.value.id]});const B=n.value?`https://admin.triplotrip.com/api/propiedades/${d.value}`:"https://admin.triplotrip.com/api/propiedades",A=n.value?"PUT":"POST";await $fetch(B,{method:A,headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({data:t})}),F.success({title:"Propiedad guardada correctamente"}),p.value=!1,r.value={Titulo:"",Descripcion:"",FotoPrincipal:null},v.value=null,g.value=!1,d.value=null,n.value=!1,await I()}catch(e){console.error(e),F.error({title:"Error",content:e.message||"No se pudo guardar"})}}return K(I),(e,a)=>(c(),y("div",re,[h.value?(c(),y("div",ie," Cargando imágenes... ")):E("",!0),a[10]||(a[10]=s("div",{class:"page-header"},[s("div",{class:"title"},"Propiedades")],-1)),s("div",ne,[s("div",se,[i(l(w),{onClick:M},{default:o(()=>[...a[4]||(a[4]=[m("Nueva propiedad",-1)])]),_:1})]),s("div",ue,[(c(!0),y(Q,null,X(f.value,(t,B)=>(c(),y("div",{key:t.documentId,class:"card-wrap"},[i(l(Y),{hoverable:"",class:"property-card"},{cover:o(()=>[s("img",{class:"property-image",alt:t.Titulo||"Imagen",src:C(t.FotoPrincipal),onLoad:$,onError:$},null,40,de)]),header:o(()=>[s("span",null,b(t.Titulo),1)]),default:o(()=>[s("p",null,b(t.Descripcion),1)]),footer:o(()=>[i(l(w),{size:"small",onClick:A=>O(t)},{default:o(()=>[...a[5]||(a[5]=[m("Editar",-1)])]),_:1},8,["onClick"])]),_:2},1024)]))),128))]),i(l(Z),{show:p.value,"onUpdate:show":a[3]||(a[3]=t=>p.value=t),preset:"dialog",title:n.value?"Editar propiedad":"Crear nueva propiedad",style:{width:"600px"}},{action:o(()=>[s("div",me,[i(l(w),{onClick:a[2]||(a[2]=t=>p.value=!1)},{default:o(()=>[...a[8]||(a[8]=[m("Cancelar",-1)])]),_:1}),n.value?(c(),N(l(w),{key:0,type:"error",ghost:"",onClick:R},{default:o(()=>[...a[9]||(a[9]=[m(" Eliminar ",-1)])]),_:1})):E("",!0),i(l(w),{type:"primary",onClick:J},{default:o(()=>[m(b(n.value?"Guardar cambios":"Crear propiedad"),1)]),_:1})])]),default:o(()=>[i(l(oe),{ref_key:"formRef",ref:D,model:r.value,rules:q,"label-placement":"top"},{default:o(()=>[i(l(k),{label:"Título",path:"Titulo"},{default:o(()=>[i(l(L),{value:r.value.Titulo,"onUpdate:value":a[0]||(a[0]=t=>r.value.Titulo=t),placeholder:"Ingresá el título de la propiedad"},null,8,["value"])]),_:1}),i(l(k),{label:"Descripción",path:"Descripcion"},{default:o(()=>[i(l(L),{value:r.value.Descripcion,"onUpdate:value":a[1]||(a[1]=t=>r.value.Descripcion=t),type:"textarea",placeholder:"Ingresá una descripción",autosize:{minRows:3}},null,8,["value"])]),_:1}),i(l(k),{label:"Foto principal",path:"FotoPrincipal"},{default:o(()=>[i(l(S),{"default-upload":!1,"on-change":V,accept:"image/*"},{default:o(()=>[i(l(le),null,{default:o(()=>[s("div",ce,[r.value.FotoPrincipal?(c(),N(l(U),{key:1,type:"success"},{default:o(()=>[...a[7]||(a[7]=[m("Imagen seleccionada",-1)])]),_:1})):(c(),N(l(U),{key:0},{default:o(()=>[...a[6]||(a[6]=[m("Arrastrá o seleccioná una imagen",-1)])]),_:1}))])]),_:1})]),_:1})]),_:1}),i(l(S),null,{default:o(()=>[n.value&&g.value&&!r.value.FotoPrincipal?(c(),y("div",pe,[i(l(k),{label:"Foto actual"},{default:o(()=>[s("img",{src:C(v.value),alt:"Foto actual",style:{display:"block","margin-top":"8px","max-width":"100%","object-fit":"cover","border-radius":"8px"}},null,8,ve)]),_:1})])):E("",!0)]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])])]))}}),Ie=ae(fe,[["__scopeId","data-v-69c6737d"]]);export{Ie as default};
